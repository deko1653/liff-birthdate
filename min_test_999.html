<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>生年月日入力</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;padding:16px}
    input,button{font-size:16px;padding:10px;width:100%;max-width:360px}
    button{margin-top:10px}
    pre{white-space:pre-wrap;background:#f6f6f6;padding:10px;border-radius:8px;max-width:360px}
  </style>
</head>
<body>
  <h2>生年月日を入力してください</h2>
  <div>生年月日（8桁）</div>
  <input id="birth" inputmode="numeric" placeholder="YYYYMMDD" />
  <button id="btn">決定</button>
  <pre id="out">起動中...</pre>

<script>
  const LIFF_ID = "2008865403-FdrRPZfH";
  const GAS_URL = "https://script.google.com/macros/s/AKfycbxJ7hHalo4GQgnXIXRgaEa75spmsdNLZ69ei6FB-72eUHNdzTFnYr-yx_xpXuO9ymc7Vw/exec";

  const out = (s) => document.getElementById("out").textContent = s;

  function yyyymmddToDashed(t){
    const s = String(t || "").trim();
    if (!/^\d{8}$/.test(s)) return null;
    return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
  }

  async function ensureLogin(){
    // ここが肝：ログイン未完了なら、先にログインへ飛ばす（APIは触らない）
    if (!liff.isLoggedIn()){
      out("LINEログインが必要です。ログイン画面へ移動します…");
      liff.login({ redirectUri: location.href });
      return false; // ここで止める
    }
    return true;
  }

  async function init(){
    try{
      out("LIFF初期化中...");
      await liff.init({ liffId: LIFF_ID });

      // 起動時点でログイン保証
      const ok = await ensureLogin();
      if (!ok) return;

      // ログイン後だけ表示
      out("ログインOK。生年月日を入力して「決定」を押してください。");
    }catch(e){
      out("初期化エラー: " + (e && e.message ? e.message : e));
    }
  }

  async function submitBirth(){
    try{
      const ok = await ensureLogin();
      if (!ok) return;

      const raw = document.getElementById("birth").value;
      const birth = yyyymmddToDashed(raw);
      if (!birth){
        alert("8桁で入力してね（例：19700314）");
        return;
      }

      // accessToken / idToken は「ログイン後」だけ取得する
      const accessToken = liff.getAccessToken();
      const idToken = liff.getIDToken();
      if (!accessToken){
        alert("accessTokenが取れません（ログイン未完了の可能性）。もう一度開き直してね。");
        return;
      }

      out("送信中... " + birth);

      // GASへ送る（まずは受け取れるか確認）
      const res = await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ birthdate: birth, idToken })
      });
      const text = await res.text();

      // ★ここで「一発で」トークへ結果を返す：送って閉じる
      await liff.sendMessages([
        { type: "text", text: text }
      ]);

      liff.closeWindow();

    }catch(e){
      out("送信エラー: " + (e && e.message ? e.message : e));
      alert("エラー: " + (e && e.message ? e.message : e));
    }
  }

  document.getElementById("btn").addEventListener("click", submitBirth);
  init();
</script>
</body>
</html>
