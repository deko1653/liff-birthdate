<div style="padding:10px;background:#ffeb3b;border-radius:8px;margin-bottom:10px;">
  ä»Šè¦‹ã¦ã„ã‚‹ã®ã¯ <b>v3</b> ã§ã™
</div>

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç”Ÿå¹´æœˆæ—¥å…¥åŠ›</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;padding:16px;line-height:1.5}
    .box{max-width:520px;margin:0 auto}
    label{display:block;margin:12px 0 6px}
    input{width:100%;padding:12px;font-size:16px}
    button{width:100%;padding:14px;font-size:18px;margin-top:12px;cursor:pointer}
    pre{white-space:pre-wrap;background:#f6f6f6;border:1px solid #ddd;padding:12px;border-radius:8px;margin-top:12px}
  </style>
</head>

<body>
  <div class="box">
 <h2>ã€v3è¡¨ç¤ºä¸­ã€‘ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>

 

    <label for="birthdate">ç”Ÿå¹´æœˆæ—¥ï¼ˆ8æ¡ï¼‰</label>
    <input
      id="birthdate"
      type="text"
      inputmode="numeric"
      autocomplete="off"
      placeholder="ä¾‹ï¼‰19900101"
    />

    <button id="btn" type="button">æ±ºå®š</button>

    <pre id="log">åˆæœŸåŒ–ä¸­â€¦</pre>
  </div>

  <script>
    // â˜…ã“ã“ã ã‘è‡ªåˆ†ã®å€¤ã«ç½®ãæ›ãˆ
   const LIFF_ID = "2008860126-ZgBrn5il"; // â† Aã«åˆã‚ã›ã‚‹

    const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwXRKrPlIuhrv60G47WPsX9g9r_LUE7b6vuPK2_RmNeoYKQaKits-tPdVBX6b2WiuYwtA/exec";

    const logEl = document.getElementById("log");
    const btnEl = document.getElementById("btn");

    function log(msg){
      logEl.textContent = msg;
    }

    // ã‚¯ãƒªãƒƒã‚¯ãŒåŠ¹ãã‹æœ€å„ªå…ˆã§ç¢ºèª
    btnEl.addEventListener("click", async () => {
      alert("ã‚¯ãƒªãƒƒã‚¯OK");
      await onSubmitBirthdate();
    });

    async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()// âœ… idTokenã‚’å–å¾—ï¼ˆaccessTokenã¯ä½¿ã‚ãªã„ï¼‰
const idToken = liff.getIDToken();
if (!idToken) {
  alert("X: idTokenãŒå–ã‚Œãªã„ã®ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™");
  liff.login();
  return;
}
) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    log(
      "æº–å‚™OK\n" +
      "ãƒ¦ãƒ¼ã‚¶ãƒ¼: " + profile.displayName + "\n" +
      "userId: " + profile.userId,
      true
    );

  } catch (err) {
    log("LIFF åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:\n" + (err.message || String(err)));
  }
}

    init();
alert("INIT START");
alert(
  "isInClient=" + liff.isInClient() + "\n" +
  "isLoggedIn=" + liff.isLoggedIn() + "\n" +

  "liffId=" + LIFF_ID
);

    async function onSubmitBirthdate(){
    // âœ… ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¦ãªã‘ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ã«é£›ã°ã™ï¼ˆè¶…é‡è¦ï¼‰
if (!liff.isLoggedIn() || !) {
  alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ãªã®ã§ã€ã„ã£ãŸã‚“ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™");
  liff.login();
  return;
}
  
     // alert("A: é–¢æ•°ã«å…¥ã£ãŸ");

      try{
        let birthdate = document.getElementById("birthdate").value.trim();
      // alert("B: å…¥åŠ›=" + birthdate);

        // 8æ¡â†’YYYY-MM-DD
        if (/^\d{8}$/.test(birthdate)){
          birthdate = birthdate.slice(0,4) + "-" + birthdate.slice(4,6) + "-" + birthdate.slice(6,8);
        }
       // alert("C: æ•´å½¢=" + birthdate);
// ğŸ”½ ã“ã“ã‹ã‚‰è¿½åŠ ï¼ˆç›´å¾Œï¼ï¼‰

const idToken = liff.getIDToken();
if (!idToken) {
  alert("X: idTokenãŒå–ã‚Œãªã„ã®ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™");
  liff.login();
  return;
}

const payload = {
  birthdate: birthdate, // â† æ•´å½¢æ¸ˆã¿ã®å€¤
  idToken: idToken
};

const res = await fetch(GAS_WEBAPP_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(payload)
});

const text = await res.text();
alert("E: å¿œç­”=" + text);

        if (!/^\d{4}-\d{2}-\d{2}$/.test(birthdate)){
          alert("å½¢å¼NGï¼ˆ19900101 ã‹ 1990-01-01ï¼‰");
          return;
        }

        const profile = await liff.getProfile();
        alert("D: profile OK");

        const payload = { userId: profile.userId, birthdate };
        log("é€ä¿¡ä¸­â€¦\n" + JSON.stringify(payload));

        const res = await fetch(GAS_WEBAPP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const text = await res.text();
        alert("E: status=" + res.status);
        log("GASå¿œç­”:\nstatus=" + res.status + "\n" + text);

        // æˆåŠŸãªã‚‰é–‰ã˜ã‚‹ï¼ˆGASå´ã® push ãŒé£›ã¶æƒ³å®šï¼‰
        if (res.ok){
          alert("F: é€ä¿¡OK â†’ é–‰ã˜ã¾ã™");
          liff.closeWindow();
        }else{
          alert("é€ä¿¡å¤±æ•—ï¼ˆlogæ¬„ã‚’è¦‹ã¦ï¼‰");
        }

      }catch(err){
       // alert("X: ä¾‹å¤– " + (err?.message || String(err)));
        log("ä¾‹å¤–:\n" + (err?.message || String(err)));
      }
    }
  </script>
<script>
  // ğŸ” LIFFã®å®ŸçŠ¶æ…‹ã‚’è¡¨ç¤ºï¼ˆåˆ‡ã‚Šåˆ†ã‘ç”¨ï¼‰
  window.addEventListener('load', async () => {
    try {
      const info = [
        'isInClient=' + liff.isInClient(),
        'isLoggedIn=' + liff.isLoggedIn(),
        'hasToken=' + (!!liff.),
        'liffId=' + (window.LIFF_ID || 'n/a')
      ].join('\n');
      alert(info);
    } catch (e) {
      alert('LIFFçŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼\n' + e);
    }
  });
</script>
  
</body>
</html>
