<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>生年月日入力 v3</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; padding:16px;}
    .box{max-width:520px; margin:0 auto;}
    input{font-size:18px; padding:12px; width:100%; box-sizing:border-box;}
    button{font-size:18px; padding:12px 16px; margin-top:12px;}
    pre{white-space:pre-wrap; background:#f5f5f5; padding:12px; border-radius:8px;}
    .small{color:#666; font-size:13px;}
  </style>
</head>

<body>
  <div class="box">
    <h2>今見ているのは v3 です（生年月日入力）</h2>

    <p class="small">8桁（例: 19900101）または YYYY-MM-DD（例: 1990-01-01）で入力</p>

    <input id="birthdate" type="text" inputmode="numeric" autocomplete="off" placeholder="例) 19900101" />
    <button id="btn" type="button">決定</button>

    <pre id="log">boot start...</pre>
  </div>

  <script>
    // ===============================
    // ★★ あなたの値に置き換える ★★
    // ===============================
    const LIFF_ID = "2008860126-HO9WFhem"; // 例) 2008860126-HO9WFhem
    const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxszzKRKeQOB4XJfCsW77FVBrzUOzzZHF6jz5_fkZlowyNQMr2wjbQGtH0SipzA_3Uluw/exec"; // 例) https://script.google.com/macros/s/AKfy.../exec

    const logEl = document.getElementById("log");
    const btnEl = document.getElementById("btn");

    function log(msg){
      logEl.textContent += "\n" + msg;
    }

    function showAlert(title, msg){
      alert(title + "\n" + msg);
    }

    function normalizeBirthdate(input){
      let b = (input || "").trim();
      if (/^\d{8}$/.test(b)){
        b = b.slice(0,4) + "-" + b.slice(4,6) + "-" + b.slice(6,8);
      }
      if (!/^\d{4}-\d{2}-\d{2}$/.test(b)){
        throw new Error("形式が違います（8桁 or YYYY-MM-DD）: " + input);
      }
      return b;
    }

    async function ensureLogin(){
      // LINE内でもブラウザでも、まずログイン状態を作る
      if (!liff.isLoggedIn()){
        log("isLoggedIn=false → loginへ");
        liff.login(); // ここで一旦画面遷移
        return false;
      }
      log("isLoggedIn=true");
      return true;
    }

    async function postToGAS(payload){
      const res = await fetch(GAS_WEBAPP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const text = await res.text(); // GASはテキスト返しでもOK
      return { ok: res.ok, status: res.status, text };
    }

    async function onSubmitBirthdate(){
      try{
        log("---- submit start ----");

        const raw = document.getElementById("birthdate").value;
        const birthdate = normalizeBirthdate(raw);
        log("birthdate=" + birthdate);

        // ① ログイン状態を保証
        const loggedIn = await ensureLogin();
        if (!loggedIn) return; // login()で遷移するのでここで終了

        // ② IDトークン取得（アクセストークンは使わない）
        const idToken = liff.getIDToken();
        if (!idToken){
          showAlert("X", "idTokenが取れません。いったんloginします");
          liff.login();
          return;
        }
        log("idToken=OK");

        // ③ GASへ送信
        const payload = {
          kind: "birthdate_submit_v3",
          birthdate,
          idToken,
          // デバッグ用（不要なら消してOK）
          isInClient: liff.isInClient(),
          liffId: LIFF_ID
        };

        log("POST → GAS...");
        const out = await postToGAS(payload);
        log("GAS status=" + out.status);
        log("GAS text=" + out.text);

        // ④ 結果表示（GAS側の返しに応じて調整）
        showAlert("送信完了", out.text);

        // ⑤ LINE内なら閉じる（任意）
        if (liff.isInClient()){
          log("closeWindow()");
          liff.closeWindow();
        }

      }catch(e){
        console.error(e);
        showAlert("エラー", String(e && e.message ? e.message : e));
        log("ERROR: " + String(e));
      }
    }

    async function init(){
      log("SDK loaded");
      try{
        await liff.init({ liffId: LIFF_ID });
        log("✅ liff.init OK");
        log("isInClient=" + liff.isInClient());
        log("isLoggedIn=" + liff.isLoggedIn());
      }catch(e){
        console.error(e);
        log("❌ liff.init 失敗");
        log("エラー: " + e);
        showAlert("LIFF初期化失敗", String(e));
      }
    }

    // ボタン
    btnEl.addEventListener("click", async () => {
      showAlert("クリックOK", "(birthdate_v3)");
      await onSubmitBirthdate();
    });

    init();
  </script>
</body>
</html>
